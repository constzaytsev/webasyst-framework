var WaLoginAbstractForm=(s=>{var r=function(){},n=(r.className="WaLoginAbstractForm",r.def=function(t,e){for(var r=0,n=arguments.length;r<n;r++)if(void 0!==arguments[r])return arguments[r]},r.def);return r.inherit=function(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t},r.prototype.init=function(t){var e=this;e.initVars(t),e.initSubmit(),e.initErrorsAutoCleaner(),e.showErrors(e.errors),e.setFocus(),e.initCaptcha()},r.prototype.initVars=function(t){var e=this;e.$wrapper=n(e.$wrapper,(t=t||{}).$wrapper,s()),e.$form||(e.$form=e.$wrapper.find(".js-wa-form-item"),e.$form.length||(e.$form=e.$wrapper.find("form")),e.$form.length)||(e.$form=s()),e.namespace=n(e.namespace,t.namespace,""),e.$templates=n(e.$templates,t.$templates,{}),e.$templates=s.extend({error_msg:s('<em class="wa-error-msg"></em>'),info_msg:s('<div class="wa-info-msg"></div>')},e.$templates),e.classes=n(e.classes,t.classes,{}),e.classes=s.extend({error_input:"wa-error",error_msg:"wa-error-msg",uncaught_errors:"wa-uncaught-errors",messages:"wa-info-messages",messages_wrapper:"wa-info-messages-wrapper",message_msg:"wa-info-msg",field:"field"},e.classes),e.errors=n(e.errors,t.errors,{}),e.locale=n(e.locale,t.locale,{}),e.js_validate=n(e.js_validate,t.js_validate,!0),e.is_json_mode=n(e.is_json_mode,t.is_json_mode),e.className=n(e.className,r.className),e.$captcha=n(e.$captcha,e.$wrapper.find(".wa-captcha-field")),e.need_redirects=void 0===t.need_redirects||!!t.need_redirects,e.env="",e.form_type=""},r.prototype.getFormItem=function(){return this.$form},r.prototype.getFormAction=function(){var t=this;return t.$form.is("form")?t.$form.attr("action"):t.$form.data("action")},r.prototype.getSerializedFormData=function(){var t=this.getFormItem();return(t.is("form")?t:(t.find("[data-turn-off=1]").find(":input").attr("disabled",!0),t.find(":input:not(:disabled)"))).serializeArray()},r.prototype.beforeSubmit=function(){this.getFormItem().find('[name="_csrf"]').val(function(){var t=document.cookie.match(new RegExp("(?:^|; )_csrf=([^;]*)"));return t&&t[1]?decodeURIComponent(t[1]):""})},r.prototype.setFocus=function(){},r.prototype.triggerEvent=function(t){var e=this,r={env:e.env,form_type:e.form_type,form_wrapper_id:e.$wrapper.attr("id")},n=(n=Array.prototype.slice.call(arguments)).slice(1);e.$wrapper.trigger(t,n.concat([r]))},r.prototype.initCaptcha=function(){var t,r=this,e=r.$wrapper;e.find(".wa-captcha-field").length?(t=function(){r.triggerEvent("wa_auth_form_loaded"),r.triggerEvent("wa_auth_form_change_view"),r.captchaInitialized=!0,r.processPendingSubmit()},window.captchaInitialized?t():s(window).one("wa_recaptcha_loaded wa_captcha_loaded wa_smartcaptcha_loaded",t),e.find(".wa-captcha-field").find('[name="g-recaptcha-response"]').length&&new MutationObserver(t=>{for(var e of t)"attributes"===e.type&&"value"===e.attributeName&&(r.captchaInitialized=!0,r.processPendingSubmit())}).observe(e.find(".wa-captcha-field").find('[name="g-recaptcha-response"]')[0],{attributes:!0})):(r.triggerEvent("wa_auth_form_loaded"),r.captchaInitialized=!0,r.processPendingSubmit())},r.prototype.turnOffBlock=function(t){var n=this;t.data("turnOff",1).attr("data-turn-off",1).hide(),t.find(":input").attr("disabled",!0),t.find("[type=button],:submit").each(function(){var t=s(this),e=s('<div class="wa-js-old-button-place"></div>'),r=s('<div class="wa-js-new-button-place"></div>');t.after(e),e.data("button",t),r.hide(),n.getFormItem().append(r),r.html(t)}),n.triggerEvent("wa_auth_form_change_view")},r.prototype.turnOnBlock=function(t){t.find(".wa-js-old-button-place").each(function(){var t=s(this),e=t.data("button"),r=e.parent();t.after(e),t.remove(),r.remove()}),t.data("turnOff","").attr("data-turn-off","").show(),t.find(":input").attr("disabled",!1),this.triggerEvent("wa_auth_form_change_view")},r.prototype.isJsonMode=function(){return this.is_json_mode},r.prototype.formatInfoMessage=function(t,e,r){e=void 0===e||e;var n=this.$templates.info_msg.clone();return void 0!==r&&n.data("name",r).attr("data-name",r),e?n.text(s.trim(""+t)):n.html(s.trim(""+t))},r.prototype.getInfoMessages=function(t){var e=this.$wrapper,r="."+this.classes.message_msg;return t&&(r+='[data-name="'+t+'"]'),e.find(r)},r.prototype.clearInfoMessages=function(t){this.getInfoMessages(t).remove(),this.triggerEvent("wa_auth_form_change_view")},r.prototype.showInfoMessages=function(t){var o=this,a=o.$wrapper.find("."+o.classes.messages);s.each(t||{},function(r,t){var e=o.getFormInput(r),n=[];s.each((t="string"==typeof t?[t]:t)||[],function(t,e){e=o.formatInfoMessage(e,!1,r);e.data("code",t).attr("data-code",t),n.push(e)}),e.length?e.after(n):a.show().append(n)}),o.triggerEvent("wa_auth_form_change_view")},r.prototype.clearErrors=function(t){var e=this,r=e.$wrapper,n=r.find("."+e.classes.error_input),o=!1,n=(n.removeClass(e.classes.error_input),o=o||0<n.length,r.find("."+e.classes.error_msg));t||(n=n.not("[data-not-clear=1]")),o=o||0<n.length,n.each(function(){var t=s(this);"timeout"===t.data("name")&&t.data("timer")&&t.data("timer")&&"function"==typeof t.data("timer").finish&&t.data("timer").finish()}),n.remove(),r.find("."+e.classes.uncaught_errors).find("."+e.classes.error_msg).length<=0&&(r.find("."+e.classes.uncaught_errors).hide(),o=!0),o&&e.triggerEvent("wa_auth_form_change_view")},r.prototype.getErrorTemplate=function(t,e,r){return this.$templates.error_msg},r.prototype.escape=function(t){var e=s("<div>");return e.text(s.trim(""+t)),t=e.text(),e.remove(),t},r.prototype.prepareErrorText=function(t,e,r){return this.escape(e)},r.prototype.prepareErrorItem=function(t,e,r){var n=this.getErrorTemplate(t,e,r).clone().clone();return n.data("name",t).data("code",r).attr("data-name",t).attr("data-code",r),n.html(this.prepareErrorText(t,e,r)),n},r.prototype.showInputError=function(t,e){t=this.getFormInput(t);return!!t.length&&(t.parent().append(e),t.addClass(this.classes.error_input),!0)},r.prototype.getFormInput=function(t){var e=this.getFormItem(),t=this.buildFormInputName(t);return e.find('[name="'+t+'"]')},r.prototype.buildFormInputName=function(t){var e=this.namespace;return e?e+"["+t+"]":t},r.prototype.getFormField=function(t){return this.$wrapper.find("."+this.classes.field+'[data-field-id="'+t+'"]')},r.prototype.getInfoMessageItem=function(t,e){t=this.$wrapper.find("."+this.classes.message_msg+'[data-name="'+t+'"]');return void 0!==e?t.filter('[data-code="'+e+'"]'):t},r.prototype.getErrorItem=function(t,e){t=this.$wrapper.find("."+this.classes.error_msg+'[data-name="'+t+'"]');return void 0!==e?t.filter('[data-code="'+e+'"]'):t},r.prototype.showUncaughtErrors=function(t,e,r){var n=this.$wrapper.find("."+this.classes.uncaught_errors);return!!n.length&&(n.show(),r&&n.html(""),n.show().append(e),!0)},r.prototype.afterShowErrors=function(){},r.prototype.showErrors=function(t){var r=this;s.each(t||{},function(t,e){e=r.prepareErrorItems(t,e="string"==typeof e?[e]:e);r.showInputError(t,e)||r.showUncaughtErrors(t,e,!0)||!console||!console.error||s.each(e,function(){var t="Uncaught validate error: "+s(this).text();console.error(t)})}),r.afterShowErrors(),r.triggerEvent("wa_auth_form_change_view")},r.prototype.initSubmit=function(){function r(t){(t=e.onSubmit(t))&&(o&&o.abort(),o=t)}var e=this,n=e.getFormItem(),o=null;n.is("form")?n.submit(function(t){r(t)}):(n.on("click",":submit,button",function(t){var e=s(this);e.is(":disabled")||e.data("ignore")||(t.preventDefault(),r(t))}),n.on("keydown","input",function(t){13==t.keyCode&&(t.preventDefault(),n.find(":submit,button").not(":disabled").filter(":first").trigger("click"))}))},r.prototype.validate=function(){return{}},r.prototype.initErrorsAutoCleaner=function(){var o=this,t=o.getFormItem(),a={},e=":text:not([name="+o.buildFormInputName("captcha")+"]),:password";t.find(e).each(function(){var t=s(this),e=t.attr("name"),t=t.val();a[e]={val:s.trim(t||""),timer:null}}),t.on("keydown",e,function(t){var e,r,n;13!=t.keyCode&&(t=(e=s(this)).attr("name"),r=a[t]||{},n=s.trim(r.val||""),(t=r.timer||null)&&clearTimeout(t),r.timer=setTimeout(function(){var t=s.trim(e.val()||"");t!==n&&o.clearErrors(),r.val=t},300))}),t.on("change",":input",function(){var t=s(this),e=t.attr("name"),e=a[e]||{},r=s.trim(e.val||""),t=s.trim(t.val()||"");t!==r&&o.clearErrors(),e.val=t})},r.prototype.onDoneSubmitHandlers=function(){var r=this;return{errors:function(t,e){return r.showErrors(t),!0},redirect:function(t){return-1!==(t=t||"").indexOf("#")&&t===window.location.href?window.location.reload():window.location.href=t,!0},messages:function(t){return r.showInfoMessages(t),!0},rest:function(t){return!0}}},r.prototype.onDoneSubmit=function(t){var e=this.onDoneSubmitHandlers(),r=t&&"ok"===t.status,n=(t&&t.data||{}).messages||{},o=t&&t.errors||{};if(r||!e.errors||!e.errors(o,t)){if(this.isRedirectResponse(t)){r=this.getRedirectUrl(t);if(e.redirect&&e.redirect(r,t))return}!s.isEmptyObject(n)&&(e.messages&&e.messages(n,t))||e.rest&&e.rest(t)}},r.prototype.submit=function(t){t=t||{};var e=this;if(e.beforeSubmit(),e.clearErrors(!0),e.js_validate){var r=e.validate();if(!s.isEmptyObject(r))return void e.showErrors(r)}var r=e.getFormItem(),n=t.$button||r.find(":submit"),o=t.$loading||r.find(".wa-loading"),r=t.url||e.getFormAction(),a=e.getSerializedFormData();if(o.show(),n.attr("disabled",!0),document.cookie.includes("_csrf=")||e.captchaInitialized)return e.jsonPost(r,a).done(function(t){e.isRedirectResponse(t)||(n.attr("disabled",!1),o.hide()),e.onDoneSubmit(t)}).fail(function(){n.attr("disabled",!1)});e.pendingSubmit=function(){e.submit(t)}},r.prototype.processPendingSubmit=function(){this.pendingSubmit&&(this.pendingSubmit(),this.pendingSubmit=null)},r.prototype.onSubmit=function(t){if(this.isJsonMode())return t.preventDefault(),this.submit()},r.prototype.mixinVarsInData=function(t,r){return s.isPlainObject(r)?r=s.extend(r,t):s.isArray(r)?s.each(t,function(t,e){r.push({name:t,value:e})}):r&&s.each(t,function(t,e){r+="&"+t+"="+e}),r},r.prototype.beforeJsonPost=function(t,e){var r={wa_json_mode:1,need_redirects:this.need_redirects?1:0};return e=this.mixinVarsInData(r,e)},r.prototype.isRedirectResponse=function(t){return null!==this.getRedirectUrl(t)},r.prototype.getRedirectUrl=function(t){t=t&&"ok"===t.status&&t.data&&t.data.redirect_url;return"string"==typeof t?t:null},r.prototype.jsonPost=function(t,e){var r=this;return e=r.beforeJsonPost(t,e),s.post(t,e,"json").always(function(t){r.isRedirectResponse(t)||s(".wa-captcha-refresh").trigger("click")})},r.prototype.beforeErrorTimerStart=function(t,e,r){},r.prototype.afterErrorTimerFinish=function(t,e,r){},r.prototype.prepareTimeoutErrorItem=function(t,e,r){var n=this,o=n.prepareErrorItem("timeout",t);return r=r||{},n.beforeErrorTimerStart(t,e,r),o.data("notClear",1).attr("data-not-clear",1),n.runTimeoutMessage(o,{timeout:e,onFinish:function(){o.remove(),n.afterErrorTimerFinish(t,e,r)}}),o},r.prototype.prepareErrorItems=function(r,t){var e,n=this,o=[];return"timeout"===r?(e=t.message,o=[n.prepareTimeoutErrorItem(e,t.timeout,{error_namespace:r})]):s.each(t||[],function(t,e){e="timeout"===t?n.prepareTimeoutErrorItem(e.message,e.timeout,{error_namespace:r,error_code:t}):n.prepareErrorItem(r,e,t);o.push(e)}),o},r.prototype.runTimeoutMessage=function(n,t){var o,a=t.timeout,e=s.trim(n.html()),r=t.onFinish,i=null,a=parseInt(a,10);if(a=!isNaN(a)&&0<a?a:60,r="function"==typeof r?r:null,e.match(/\d+:\d/))return this.triggerEvent("wa_auth_form_change_view"),o=function(){i&&clearInterval(i),n.remove(),r&&r()},i=setInterval(function(){var t,e,r;--a<=0?o():(r=n.html(),t=parseInt(a/60,10),e=a%60,r=r.replace(/\d+:\d+/,(t<=9?"0"+t:t)+":"+(e<=9?"0"+e:e)),n.html(r))},1e3),n.data("timer",t={finish:o}),t},r})(jQuery),WaLoginAbstractLoginForm=(i=>{var r=WaLoginAbstractLoginForm=function(){},n=(r.className="WaLoginAbstractLoginForm",WaLoginAbstractForm),o=WaLoginAbstractForm.def;return((r.prototype=Object.create(n.prototype)).constructor=r).prototype.init=function(t){n.prototype.init.call(this,t)},r.prototype.initVars=function(t){var e=this;e.auth_type=o(e.auth_type,(t=t||{}).auth_type,""),e.className=o(e.className,r.className),n.prototype.initVars.call(e,t),e.timeout=o(e.timeout,0),e.timeout=isNaN(e.timeout)||e.timeout<=0?60:e.timeout,e.form_type="login"},r.prototype.setFocus=function(){var t=this.getFormInput("login"),e=this.getFormInput("password");(i.trim(t.val()||"")?e:t).focus()},r.prototype.validate=function(n){var o=this,t=o.getSerializedFormData(),a={};return i.each(t,function(t,e){var r=e.name,e=i.trim(e.value||"");r!==o.buildFormInputName("login")||e||(a.login=[o.locale.login_required||o.locale.required||""]),r!==o.buildFormInputName("captcha")||e||(a.captcha=[o.locale.captcha_required||o.locale.required||""]),n||r!==o.buildFormInputName("password")||e||(a.password=[o.locale.password_required||o.locale.required||""])}),a},r.prototype.prepareErrorItem=function(t,e,r){e=n.prototype.prepareErrorItem.call(this,t,e,r);return this.isOneTimePasswordMode()&&"password"===t&&"out_of_tries"===r&&(t=this.getFormInput("password"),r=this.getFormItem(),t.attr("readonly",!0),r.find(".wa-login-submit").attr("disabled",!0)),e},r.prototype.isOneTimePasswordMode=function(){return"onetime_password"===this.auth_type},r.prototype.onSentOnetimePassword=function(t){this.showInfoMessages((t=t||{}).messages||{})},r.prototype.initOnetimePasswordLink=function(t){var r,n=this,o=(t=t||{}).$link,a=t.$loading;o.length&&n.isOneTimePasswordMode()&&(r=null,o.data("ignore","1"),o.on("click",function(t){if(t.preventDefault(),n.clearErrors(),n.js_validate){t=n.validate(!0);if(!i.isEmptyObject(t))return void n.showErrors(t)}var e;r||(t=o.attr("href")||o.data("href"),a.show(),o.attr("disabled",!0),e=n.getSerializedFormData(),n.clearErrors(),r=n.jsonPost(t,e).done(function(t){o.attr("disabled",!1),t&&"ok"===t.status?n.onSentOnetimePassword(t.data):n.showErrors(t&&t.errors||{})}).fail(function(){o.attr("disabled",!1)}).always(function(){r=null,a.hide()}))}))},r})(jQuery),WaBackendLogin=(o=>{var r=function(t){this.init(t)},n=(r.className="WaBackendLogin",WaLoginAbstractLoginForm);return WaLoginAbstractForm.inherit(r,n),r.prototype.init=function(t){var e=this;n.prototype.init.call(e,t),e.initCancelButton(),e.initOnetimePasswordLink({$link:e.$wrapper.find(".wa-request-onetime-password-button"),$loading:e.$wrapper.find(".wa-request-onetime-password-button-loading")}),e.initOnetimePasswordLink({$link:e.$wrapper.find(".wa-request-onetime-password-link"),$loading:e.$wrapper.find(".wa-request-onetime-password-link-loading")}),e.webasyst_id_auth_url&&e.initWebasystIDAuthLink(),e.bind_with_webasyst_contact&&e.initSignInAndBindWithWebasystID()},r.prototype.initCancelButton=function(){var e=this,r=e.getFormItem();r.find(".wa-login-cancel").on("click",function(t){t.preventDefault(),e.is_json_mode=!1,r.append('<input type="hidden" name="cancel" value="1" />'),r.submit()})},r.prototype.initVars=function(t){var e=this;e.className=r.className,n.prototype.initVars.call(e,t),e.$wrapper.data("WaAuthForm",e),e.is_json_mode=!0,e.env="backend",e.wa_app_url=t.wa_app_url||"",e.webasyst_id_auth_url=t.webasyst_id_auth_url||"",e.bind_with_webasyst_contact=t.bind_with_webasyst_contact||!1},r.prototype.setupOnetimePasswordView=function(){var t=this,e=t.$wrapper,r=t.getFormField("password");t.makeInputReadonly("login",!1),t.turnOffBlock(r),t.turnOffBlock(e.find(".wa-submit-button-wrapper")),t.turnOnBlock(e.find(".wa-request-onetime-password-button-wrapper")),t.turnOffBlock(e.find(".field-remember-me")),e.find(".wa-change-login-link").hide(),e.find(".wa-request-onetime-password-link-wrapper").hide(),r.find("."+t.classes.message_msg).remove(),t.triggerEvent("wa_auth_form_change_view")},r.prototype.onSentOnetimePassword=function(t){t=t||{};var e=this,r=e.$wrapper,n=e.getFormField("password"),o=e.getFormInput("password"),a=(e.makeInputReadonly("login"),e.turnOnBlock(n),o.removeAttr("readonly").val(""),e.turnOnBlock(r.find(".wa-submit-button-wrapper")),e.turnOffBlock(r.find(".wa-request-onetime-password-button-wrapper")),e.turnOnBlock(r.find(".field-remember-me")),e.initChangeLoginLink(),e.clearInfoMessages("password"),e.showInfoMessages({password:{timeout:t.onetime_password_timeout_message,sent_message:t.onetime_password_sent_message}}),r.find(".wa-change-login-link").hide(),r.find(".wa-request-onetime-password-link-wrapper").hide(),e.getInfoMessageItem("password","timeout"));e.runTimeoutMessage(a,{timeout:t.onetime_password_timeout,onFinish:function(){r.find(".wa-change-login-link").show(),r.find(".wa-request-onetime-password-link-wrapper").show(),a.remove()}})},r.prototype.initChangeLoginLink=function(){var t=this;t.$wrapper.find(".wa-change-login-link").one("click",function(){t.setupOnetimePasswordView()})},r.prototype.makeInputReadonly=function(t,e){e=void 0===e||!!e;var r,t=this.getFormInput(t);t.attr("disabled",e),e?(e=t.attr("name"),r=t.val(),(r=o('<input type="hidden">').attr("name",e).val(r)).insertAfter(t),t.data("hidden_clone",r)):(r=t.data("hidden_clone")).length&&r.remove()},r.prototype.onDoneSubmitHandlers=function(){var t=n.prototype.onDoneSubmitHandlers.call(this);return t.redirect=function(t){var e=window.location.href||"",r=0===e.indexOf(t),e=-1!==e.indexOf("#");r&&e?window.location.reload():window.location.href=t},t},r.prototype.initWebasystIDAuthLink=function(r){var t=this.$wrapper,e=t.find(".js-webasyst-auth-link"),n=t.find(".field-remember-me").find(":checkbox");e.on("click",function(t){t.preventDefault();var e,t=o(this).attr("href")||"";n.is(":checked")&&(t=t.replace("backend_auth=1","backend_auth=2")),r?(e=(screen.width-600)/2,window.open(t,"oauth","width=600,height=500,left="+e+",top="+(screen.height-500)/2+",status=no,toolbar=no,menubar=no")):window.location=t})},r.prototype.initSignInAndBindWithWebasystID=function(){var e=this;o(".js-back-to-simple-login").on("click",function(t){t.preventDefault(),o.post(e.wa_app_url+"?module=login&action=reset",function(){window.location.reload()})})},r})(jQuery);
//# sourceMappingURL=login-backend-form.min.js.map
